name: Container CI/CD Pipeline (Docker/Podman)

on:
  workflow_call:
    inputs:
      container-engine:
        description: 'Container engine (docker or podman)'
        required: false
        default: 'auto'  # Ëá™ÂãïÊ§úÂá∫
        type: string
      
      image-name:
        description: 'Image name'
        required: true
        type: string
      
      dockerfile:
        description: 'Dockerfile path'
        required: false
        default: 'Dockerfile'
        type: string
      
      build-args:
        description: 'Build arguments (JSON format)'
        required: false
        default: '{}'
        type: string
      
      platforms:
        description: 'Target platforms (comma-separated)'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: string
      
      run-tests:
        description: 'Run container tests'
        required: false
        default: true
        type: boolean
      
      push-to-registry:
        description: 'Push to registry'
        required: false
        default: false
        type: boolean
      
      registry:
        description: 'Container registry (docker.io, ghcr.io, quay.io)'
        required: false
        default: 'docker.io'
        type: string
      
      working-directory:
        required: false
        default: '.'
        type: string
      
      environment:
        required: false
        default: 'dev'
        type: string
    
    secrets:
      REGISTRY_USERNAME:
        required: false
      REGISTRY_PASSWORD:
        required: false
      REGISTRY_TOKEN:
        required: false

jobs:
  # „Ç≥„É≥„ÉÜ„Éä„Ç®„É≥„Ç∏„É≥„ÅÆÊ§úÂá∫„Å®Ê∫ñÂÇô
  setup:
    name: Setup Container Engine
    runs-on: [self-hosted, macOS, ARM64]
    outputs:
      engine: ${{ steps.detect.outputs.engine }}
      engine-path: ${{ steps.detect.outputs.path }}
    
    steps:
      - name: Detect container engine
        id: detect
        run: |
          if [ "${{ inputs.container-engine }}" = "auto" ]; then
            # Ëá™ÂãïÊ§úÂá∫
            if command -v podman &> /dev/null; then
              echo "engine=podman" >> $GITHUB_OUTPUT
              echo "path=$(which podman)" >> $GITHUB_OUTPUT
              echo "‚úÖ Podman detected"
            elif command -v docker &> /dev/null; then
              echo "engine=docker" >> $GITHUB_OUTPUT
              echo "path=$(which docker)" >> $GITHUB_OUTPUT
              echo "‚úÖ Docker detected"
            else
              echo "‚ùå No container engine found"
              exit 1
            fi
          else
            # ÊâãÂãïÊåáÂÆö
            ENGINE="${{ inputs.container-engine }}"
            if command -v $ENGINE &> /dev/null; then
              echo "engine=$ENGINE" >> $GITHUB_OUTPUT
              echo "path=$(which $ENGINE)" >> $GITHUB_OUTPUT
              echo "‚úÖ Using $ENGINE"
            else
              echo "‚ùå $ENGINE not found"
              exit 1
            fi
          fi
      
      - name: Show engine info
        run: |
          ENGINE="${{ steps.detect.outputs.engine }}"
          $ENGINE --version
          $ENGINE info || true

  # „Ç≥„É≥„ÉÜ„Éä„Ç§„É°„Éº„Ç∏„ÅÆ„Éì„É´„Éâ
  build:
    name: Build Container Image
    runs-on: [self-hosted, macOS, ARM64]
    needs: setup
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up QEMU (for multi-platform)
        if: contains(inputs.platforms, ',')
        run: |
          ENGINE="${{ needs.setup.outputs.engine }}"
          if [ "$ENGINE" = "docker" ]; then
            docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          fi
      
      - name: Parse build args
        id: build-args
        run: |
          BUILD_ARGS='${{ inputs.build-args }}'
          echo "args=$BUILD_ARGS" >> $GITHUB_OUTPUT
      
      - name: Build image (Docker)
        if: needs.setup.outputs.engine == 'docker'
        run: |
          # Build arguments „ÇíÂ±ïÈñã
          BUILD_ARGS_CMD=""
          if [ '${{ inputs.build-args }}' != '{}' ]; then
            BUILD_ARGS_CMD=$(echo '${{ inputs.build-args }}' | jq -r 'to_entries | map("--build-arg \(.key)=\(.value)") | join(" ")')
          fi
          
          docker build \
            --file ${{ inputs.dockerfile }} \
            --tag ${{ inputs.image-name }}:${{ github.sha }} \
            --tag ${{ inputs.image-name }}:${{ inputs.environment }} \
            --tag ${{ inputs.image-name }}:latest \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg VCS_REF=${{ github.sha }} \
            --build-arg ENV=${{ inputs.environment }} \
            $BUILD_ARGS_CMD \
            .
      
      - name: Build image (Podman)
        if: needs.setup.outputs.engine == 'podman'
        run: |
          # Build arguments „ÇíÂ±ïÈñã
          BUILD_ARGS_CMD=""
          if [ '${{ inputs.build-args }}' != '{}' ]; then
            BUILD_ARGS_CMD=$(echo '${{ inputs.build-args }}' | jq -r 'to_entries | map("--build-arg \(.key)=\(.value)") | join(" ")')
          fi
          
          podman build \
            --file ${{ inputs.dockerfile }} \
            --tag ${{ inputs.image-name }}:${{ github.sha }} \
            --tag ${{ inputs.image-name }}:${{ inputs.environment }} \
            --tag ${{ inputs.image-name }}:latest \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg VCS_REF=${{ github.sha }} \
            --build-arg ENV=${{ inputs.environment }} \
            $BUILD_ARGS_CMD \
            .
      
      - name: Build multi-platform (Docker with buildx)
        if: needs.setup.outputs.engine == 'docker' && contains(inputs.platforms, ',')
        run: |
          docker buildx create --use --name multi-platform-builder
          
          docker buildx build \
            --platform ${{ inputs.platforms }} \
            --file ${{ inputs.dockerfile }} \
            --tag ${{ inputs.image-name }}:${{ inputs.environment }} \
            --build-arg ENV=${{ inputs.environment }} \
            --load \
            .
      
      - name: Build multi-platform (Podman)
        if: needs.setup.outputs.engine == 'podman' && contains(inputs.platforms, ',')
        run: |
          # Podman „ÅÆ manifest Ê©üËÉΩ„Çí‰ΩøÁî®
          IFS=',' read -ra PLATFORMS <<< "${{ inputs.platforms }}"
          
          for PLATFORM in "${PLATFORMS[@]}"; do
            podman build \
              --platform $PLATFORM \
              --file ${{ inputs.dockerfile }} \
              --tag ${{ inputs.image-name }}:${{ inputs.environment }}-${PLATFORM//\//-} \
              --build-arg ENV=${{ inputs.environment }} \
              .
          done
          
          # Manifest „Çí‰ΩúÊàê
          podman manifest create ${{ inputs.image-name }}:${{ inputs.environment }}
          
          for PLATFORM in "${PLATFORMS[@]}"; do
            podman manifest add \
              ${{ inputs.image-name }}:${{ inputs.environment }} \
              ${{ inputs.image-name }}:${{ inputs.environment }}-${PLATFORM//\//-}
          done
      
      - name: Inspect image
        run: |
          ENGINE="${{ needs.setup.outputs.engine }}"
          $ENGINE images ${{ inputs.image-name }}
          $ENGINE inspect ${{ inputs.image-name }}:${{ inputs.environment }} | jq '.[0].Config'

  # „Ç≥„É≥„ÉÜ„Éä„ÉÜ„Çπ„Éà
  test:
    name: Test Container
    runs-on: [self-hosted, macOS, ARM64]
    needs: [setup, build]
    if: inputs.run-tests
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run container test
        run: |
          ENGINE="${{ needs.setup.outputs.engine }}"
          
          echo "üß™ Testing container startup..."
          CONTAINER_ID=$($ENGINE run -d ${{ inputs.image-name }}:${{ inputs.environment }})
          
          echo "Container ID: $CONTAINER_ID"
          sleep 5
          
          echo "üìã Container logs:"
          $ENGINE logs $CONTAINER_ID
          
          echo "üîç Container status:"
          $ENGINE ps -a | grep $CONTAINER_ID
          
          echo "üßπ Cleanup"
          $ENGINE stop $CONTAINER_ID
          $ENGINE rm $CONTAINER_ID
      
      - name: Run health check
        run: |
          ENGINE="${{ needs.setup.outputs.engine }}"
          
          echo "üè• Testing health check..."
          $ENGINE run --rm ${{ inputs.image-name }}:${{ inputs.environment }} \
            sh -c "command -v python && python --version" || \
            sh -c "command -v node && node --version" || \
            echo "Basic test passed"
      
      - name: Security scan (Trivy)
        run: |
          ENGINE="${{ needs.setup.outputs.engine }}"
          
          # Trivy „Çí„Ç§„É≥„Çπ„Éà„Éº„É´Ôºà„Å™„Åë„Çå„Å∞Ôºâ
          if ! command -v trivy &> /dev/null; then
            brew install aquasecurity/trivy/trivy
          fi
          
          echo "üîí Scanning for vulnerabilities..."
          trivy image --severity HIGH,CRITICAL ${{ inputs.image-name }}:${{ inputs.environment }} || true

  # „É¨„Ç∏„Çπ„Éà„É™„Å∏„ÅÆ„Éó„ÉÉ„Ç∑„É•
  push:
    name: Push to Registry
    runs-on: [self-hosted, macOS, ARM64]
    needs: [setup, build, test]
    if: inputs.push-to-registry
    
    steps:
      - name: Login to registry (Docker)
        if: needs.setup.outputs.engine == 'docker'
        run: |
          REGISTRY="${{ inputs.registry }}"
          
          if [ "$REGISTRY" = "ghcr.io" ]; then
            # GitHub Container Registry
            echo "${{ secrets.REGISTRY_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          else
            # Docker Hub or other
            echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login $REGISTRY -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin
          fi
      
      - name: Login to registry (Podman)
        if: needs.setup.outputs.engine == 'podman'
        run: |
          REGISTRY="${{ inputs.registry }}"
          
          if [ "$REGISTRY" = "ghcr.io" ]; then
            echo "${{ secrets.REGISTRY_TOKEN }}" | podman login ghcr.io -u ${{ github.actor }} --password-stdin
          else
            echo "${{ secrets.REGISTRY_PASSWORD }}" | podman login $REGISTRY -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin
          fi
      
      - name: Tag for registry
        run: |
          ENGINE="${{ needs.setup.outputs.engine }}"
          REGISTRY="${{ inputs.registry }}"
          
          # Registry „ÅÆ„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇíËøΩÂä†
          if [ "$REGISTRY" = "ghcr.io" ]; then
            FULL_NAME="ghcr.io/${{ github.repository_owner }}/${{ inputs.image-name }}"
          else
            FULL_NAME="$REGISTRY/${{ secrets.REGISTRY_USERNAME }}/${{ inputs.image-name }}"
          fi
          
          $ENGINE tag ${{ inputs.image-name }}:${{ inputs.environment }} $FULL_NAME:${{ inputs.environment }}
          $ENGINE tag ${{ inputs.image-name }}:${{ inputs.environment }} $FULL_NAME:${{ github.sha }}
          
          if [ "${{ inputs.environment }}" = "production" ]; then
            $ENGINE tag ${{ inputs.image-name }}:${{ inputs.environment }} $FULL_NAME:latest
          fi
      
      - name: Push to registry (Docker)
        if: needs.setup.outputs.engine == 'docker'
        run: |
          REGISTRY="${{ inputs.registry }}"
          
          if [ "$REGISTRY" = "ghcr.io" ]; then
            FULL_NAME="ghcr.io/${{ github.repository_owner }}/${{ inputs.image-name }}"
          else
            FULL_NAME="$REGISTRY/${{ secrets.REGISTRY_USERNAME }}/${{ inputs.image-name }}"
          fi
          
          docker push $FULL_NAME:${{ inputs.environment }}
          docker push $FULL_NAME:${{ github.sha }}
          
          if [ "${{ inputs.environment }}" = "production" ]; then
            docker push $FULL_NAME:latest
          fi
      
      - name: Push to registry (Podman)
        if: needs.setup.outputs.engine == 'podman'
        run: |
          REGISTRY="${{ inputs.registry }}"
          
          if [ "$REGISTRY" = "ghcr.io" ]; then
            FULL_NAME="ghcr.io/${{ github.repository_owner }}/${{ inputs.image-name }}"
          else
            FULL_NAME="$REGISTRY/${{ secrets.REGISTRY_USERNAME }}/${{ inputs.image-name }}"
          fi
          
          podman push $FULL_NAME:${{ inputs.environment }}
          podman push $FULL_NAME:${{ github.sha }}
          
          if [ "${{ inputs.environment }}" = "production" ]; then
            podman push $FULL_NAME:latest
          fi

  # „Çµ„Éû„É™„Éº
  report:
    name: Build Summary
    runs-on: [self-hosted, macOS, ARM64]
    needs: [setup, build, test]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## üê≥ Container Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Engine**: ${{ needs.setup.outputs.engine }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: ${{ inputs.image-name }}:${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Registry**: ${{ inputs.registry }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test: ${{ needs.test.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY


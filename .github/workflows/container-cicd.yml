name: Container CI/CD Pipeline

on:
  workflow_call:
    inputs:
      container-engine:
        description: 'Container engine (docker or podman)'
        required: false
        default: 'auto'
        type: string
      
      image-name:
        description: 'Image name'
        required: true
        type: string
      
      dockerfile:
        description: 'Dockerfile path'
        required: false
        default: 'Dockerfile'
        type: string
      
      build-args:
        description: 'Build arguments (JSON format)'
        required: false
        default: '{}'
        type: string
      
      platforms:
        description: 'Target platforms (comma-separated)'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: string
      
      run-tests:
        description: 'Run container tests'
        required: false
        default: true
        type: boolean
      
      push-to-registry:
        description: 'Push to registry'
        required: false
        default: false
        type: boolean
      
      registry:
        description: 'Container registry'
        required: false
        default: 'docker.io'
        type: string
      
      working-directory:
        required: false
        default: '.'
        type: string
      
      environment:
        required: false
        default: 'dev'
        type: string
    
    secrets:
      REGISTRY_USERNAME:
        required: false
      REGISTRY_PASSWORD:
        required: false
      GITHUB_TOKEN:
        required: false

jobs:
  setup:
    name: Setup Container Engine
    runs-on: self-hosted
    outputs:
      engine: ${{ steps.detect.outputs.engine }}
    
    steps:
      - name: Detect container engine
        id: detect
        run: |
          if [ "${{ inputs.container-engine }}" = "auto" ]; then
            if command -v podman &> /dev/null; then
              echo "engine=podman" >> $GITHUB_OUTPUT
              echo "âœ… Podman detected"
            elif command -v docker &> /dev/null; then
              echo "engine=docker" >> $GITHUB_OUTPUT
              echo "âœ… Docker detected"
            else
              echo "âŒ No container engine found"
              exit 1
            fi
          else
            ENGINE="${{ inputs.container-engine }}"
            if command -v $ENGINE &> /dev/null; then
              echo "engine=$ENGINE" >> $GITHUB_OUTPUT
            else
              echo "âŒ $ENGINE not found"
              exit 1
            fi
          fi
      
      - name: Show engine info
        run: |
          ENGINE="${{ steps.detect.outputs.engine }}"
          $ENGINE --version

  build:
    name: Build Container Image
    runs-on: self-hosted
    needs: setup
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          # jq ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãªã‘ã‚Œã°ï¼‰
          if ! command -v jq &> /dev/null; then
            brew install jq
          fi
      
      - name: Parse build args
        id: parse-args
        run: |
          BUILD_ARGS='${{ inputs.build-args }}'
          if [ "$BUILD_ARGS" != '{}' ]; then
            ARGS_STRING=$(echo "$BUILD_ARGS" | jq -r 'to_entries | map("--build-arg \(.key)=\(.value)") | join(" ")')
            echo "args=$ARGS_STRING" >> $GITHUB_OUTPUT
          else
            echo "args=" >> $GITHUB_OUTPUT
          fi
      
      - name: Build with Docker
        if: needs.setup.outputs.engine == 'docker'
        run: |
          # ã‚·ãƒ³ã‚°ãƒ«ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ‰
          if [ "${{ inputs.platforms }}" = "linux/amd64" ] || [ "${{ inputs.platforms }}" = "linux/arm64" ]; then
            docker build \
              --file ${{ inputs.dockerfile }} \
              --tag ${{ inputs.image-name }}:${{ inputs.environment }} \
              --tag ${{ inputs.image-name }}:${{ github.sha }} \
              --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
              --build-arg VCS_REF=${{ github.sha }} \
              ${{ steps.parse-args.outputs.args }} \
              .
          else
            # ãƒžãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ‰
            docker buildx create --use --name builder-${{ github.run_id }} || true
            docker buildx build \
              --platform ${{ inputs.platforms }} \
              --file ${{ inputs.dockerfile }} \
              --tag ${{ inputs.image-name }}:${{ inputs.environment }} \
              --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
              --build-arg VCS_REF=${{ github.sha }} \
              ${{ steps.parse-args.outputs.args }} \
              --load \
              . || \
            docker buildx build \
              --platform ${{ inputs.platforms }} \
              --file ${{ inputs.dockerfile }} \
              --tag ${{ inputs.image-name }}:${{ inputs.environment }} \
              --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
              ${{ steps.parse-args.outputs.args }} \
              .
          fi
      
      - name: Build with Podman
        if: needs.setup.outputs.engine == 'podman'
        run: |
          podman build \
            --file ${{ inputs.dockerfile }} \
            --tag ${{ inputs.image-name }}:${{ inputs.environment }} \
            --tag ${{ inputs.image-name }}:${{ github.sha }} \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg VCS_REF=${{ github.sha }} \
            ${{ steps.parse-args.outputs.args }} \
            .
      
      - name: Inspect image
        run: |
          ENGINE="${{ needs.setup.outputs.engine }}"
          $ENGINE images ${{ inputs.image-name }}

  test:
    name: Test Container
    runs-on: self-hosted
    needs: [setup, build]
    if: inputs.run-tests
    
    steps:
      - name: Run container test
        run: |
          ENGINE="${{ needs.setup.outputs.engine }}"
          
          echo "ðŸ§ª Testing container..."
          CONTAINER_ID=$($ENGINE run -d ${{ inputs.image-name }}:${{ inputs.environment }})
          sleep 5
          
          $ENGINE logs $CONTAINER_ID
          $ENGINE stop $CONTAINER_ID || true
          $ENGINE rm $CONTAINER_ID || true
      
      - name: Security scan
        run: |
          if ! command -v trivy &> /dev/null; then
            brew install aquasecurity/trivy/trivy
          fi
          
          trivy image --severity HIGH,CRITICAL \
            ${{ inputs.image-name }}:${{ inputs.environment }} || true

  push:
    name: Push to Registry
    runs-on: self-hosted
    needs: [setup, build]
    if: |
      always() && 
      needs.build.result == 'success' &&
      inputs.push-to-registry
    
    steps:
      - name: Login to GitHub Container Registry
        if: inputs.registry == 'ghcr.io'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Login to Docker Hub
        if: inputs.registry == 'docker.io'
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      
      - name: Push images
        run: |
          ENGINE="${{ needs.setup.outputs.engine }}"
          REGISTRY="${{ inputs.registry }}"
          
          if [ "$REGISTRY" = "ghcr.io" ]; then
            FULL_NAME="ghcr.io/${{ github.repository_owner }}/${{ inputs.image-name }}"
          else
            FULL_NAME="$REGISTRY/${{ secrets.REGISTRY_USERNAME }}/${{ inputs.image-name }}"
          fi
          
          $ENGINE tag ${{ inputs.image-name }}:${{ inputs.environment }} $FULL_NAME:${{ inputs.environment }}
          $ENGINE push $FULL_NAME:${{ inputs.environment }}
